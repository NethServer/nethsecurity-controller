#!/bin/sh

# Add route to traefik
username=$common_name
cat <<EOF > /etc/openvpn/proxy/$username.yaml
http:
  # Add the router
  routers:
    router$username:
      entryPoints:
      - web
      middlewares:
      - m$username-stripprefix
      service: service-$username
      rule: PathPrefix(\`/$username\`)

  # Add the service
  services:
    service-$username:
      loadBalancer:
        servers:
        - url: https://$ifconfig_pool_remote_ip:9090/
        passHostHeader: true

  # Add middleware
  middlewares:
    m$username-stripprefix:
      stripPrefix:
        prefixes:
          - "/$username"
EOF

source /etc/openvpn/db.env

/usr/bin/psql $REPORT_DB_URI -c "UPDATE units SET vpn_connected_since = NOW() WHERE uuid = '$common_name';"
