<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <title>NextSec controller</title>
  </head>
  <body>
    <h2>NextSec controller</h2>
    <button id="load_button" type="button">Load list</button>



    <h3>Server list</h3>
    <ul id="servers">
    </ul>

    <h3>Add server</h3>
    <div>
     Name: <input type="text" id="name" name="name" value=""/>
     <button id="add_button" type="button">Add</button>
    </div>

    <hr/>
    <div>
    <h5>Network info:</h5>
    <pre style="background-color: #eee" id="exec_result" >
    </pre>
    </div>

    <hr/>
    <div>
    <h5>VPN config:</h5>
    <pre style="background-color: #eee" id="config_result" >
    </pre>

    <h5>VPN credentials:</h5>
    <pre style="background-color: #eee" id="credentials_result" >
    </pre>
    </div>


    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
   <script>
        $(document).ready(function(){
            $('#add_button').click(function() {
                $.post( "/api/servers/add/"+ $('#name').val(), function( data ) {
                    console.log(data);
                    location.reload();
                });
            });

            $('#servers').on('click', '.delete_link', function() {
                to_delete = $(this).attr('value');
                console.log(to_delete);
                $.post( "/api/servers/delete/"+ to_delete, function( data ) {
                    console.log(data);
                    location.reload();
                });
            });

            $('#servers').on('click', '.network', function() {
                name = $(this).attr('value');
                token = $('#'+name+"-token").text();
                url="/"+name+"/cgi-bin/luci/rpc/uci?auth="+token;
                command = {"method": "get_all","params": ["network"]};
                console.log(url);
                $.post(url, JSON.stringify(command), function(response) {
                    console.log(response);
                    $('#exec_result').html(JSON.stringify(response, null, 2));
                }, "json");
            });

            $('#servers').on('click', '.config', function() {
                name = $(this).attr('value');
                $.get("/api/servers/config/"+ name, function(response) {
                    console.log(response);
                    $('#config_result').text(response);
                    $('#credentials_result').text(name+"\nnopass\n");
                });
            });

            $('#load_button').click(function() {
                $.getJSON('/api/servers', function(data) {
                    console.log(data);
                    $("#servers").empty();
                    jQuery.each(data, function( i, val ) {
                        $("#servers").append("<li>"+val["name"]+": "+val['ipaddress']
                                   +" Token: <span id='"+val["name"]+"-token'>-</span>" 
                                   +" <button type='button' class='network' value='"+val["name"]+"'>Network info</button>"
                                   +" <button type='button' class='config' value='"+val["name"]+"'>VPN config</button>"
                                   +" <button type='button' class='delete_link' value='"+val["name"]+"'>Delete</button>" 
                                   +"</li>");
                        login_data = {"id": 1, "method": "login", "params": ["root", "Nethesis,1234"]};
                        $.post("/"+val['name']+"/cgi-bin/luci/rpc/auth", JSON.stringify(login_data), function(response) {
                                    $("#"+val["name"]+"-token").html(response["result"]);
                                   console.log(response);
                        }, "json");
                    });
                });
            });

        });
    </script>
  </body>
</html>
